{"version":3,"sources":["src/btcswap.js"],"names":[],"mappings":";;AAAA,IAAI,SAAS,GAAG,OAAO,CAAC,cAAc,CAAC,CAAC;AACxC,IAAI,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;AAC3B,IAAI,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;AAC3B,IAAI,GAAG,GAAG,OAAO,CAAC,OAAO,CAAC,CAAC;;AAE3B,IAAI,WAAW,GAAG,IAAI,SAAS,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;;AAE5C,IAAI,eAAe,GAAG,IAAI,SAAS,CAAC,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;;AAE/C,IAAI,aAAa,GAAG,CAAC,CAAC;;AAEtB,IAAI,yBAAyB,GAAG,CAAC,EAAE,CAAC;AACpC,IAAI,gBAAgB,GAAG,CAAC,EAAE,CAAC;;AAE3B,IAAI,yBAAyB,GAAG,CAAC,EAAE,CAAC;AACpC,IAAI,qBAAqB,GAAG,CAAC,EAAE,CAAC;AAChC,IAAI,kBAAkB,GAAG,CAAC,EAAE,CAAC;AAC7B,IAAI,kBAAkB,GAAG,CAAC,EAAE,CAAC;AAC7B,IAAI,+BAA+B,GAAG,CAAC,EAAE,CAAC;AAC1C,IAAI,gBAAgB,GAAG,CAAC,EAAE,CAAC;AAC3B,IAAI,yBAAyB,GAAG,CAAC,EAAE,CAAC;AACpC,IAAI,sBAAsB,GAAG,CAAC,EAAE,CAAC;;AAEjC,IAAI,OAAO,GAAG,SAAV,OAAO,CAAY,MAAM,EAAE;AAC7B,MAAI,CAAC,MAAM,CAAC,IAAI,EAAE;AAChB,UAAM,IAAI,KAAK,CAAC,mBAAmB,CAAC,CAAC;GACtC;;AAED,MAAI,CAAC,MAAM,CAAC,OAAO,EAAE;AACnB,UAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;GAC5C;;AAED,MAAI,OAAO,MAAM,CAAC,UAAU,KAAK,WAAW,EAC1C,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,KAEvB,IAAI,CAAC,UAAU,GAAG,MAAM,CAAC,UAAU,CAAC;;AAEtC,MAAI,CAAC,WAAW,CAAC,IAAI,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC;;AAEtE,MAAI,CAAC,GAAG,CAAC,OAAO,CAAC,MAAM,CAAC,OAAO,EAAE,UAAS,GAAG,EAAE,MAAM,EAAE;AACrD,QAAI,GAAG,EAAE;AACP,YAAM,GAAG,CAAC;KACX;AACD,QAAI,MAAM,KAAK,IAAI,EAAE;AACnB,YAAM,IAAI,KAAK,CAAC,4BAA4B,CAAC,CAAC;KAC/C;GACF,CAAC,CAAC;;AAEH,MAAI,CAAC,GAAG,CAAC,cAAc,GAAG,MAAM,CAAC,IAAI,CAAC;;AAEtC,MAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;AAC1D,SAAO,CAAC,GAAG,CAAC,oBAAoB,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;;AAEjD,MAAI,CAAC,WAAW,GAAG,IAAI,CAAC,UAAU,GAAG,GAAG,GAAG,CAAC,CAAC;;AAE7C,MAAI,CAAC,YAAY,GAAG,UAAS,UAAU,EAAE,QAAQ,EAAE,QAAQ,EAAE,QAAQ,EAAE;AACrE,QAAI,OAAO,CAAC;AACZ,QAAI;AACF,aAAO,GAAG,IAAI,GAAG,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;AACzC,aAAO,CAAC,GAAG,CAAC,mBAAmB,EAAE,OAAO,CAAC,CAAC;KAC3C,CACD,OAAO,GAAG,EAAE;AACV,cAAQ,CAAC,IAAI,KAAK,CAAC,UAAU,GAAG,kCAAkC,GAAG,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC;AACnF,aAAO;KACR;AACD,QAAI,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;AAC3C,QAAI,aAAa,GAAG,IAAI,SAAS,CAAC,MAAM,CAAC,CAAC,GAAG,CAAC,eAAe,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;;AAEnG,QAAI,QAAQ,GAAG,EAAC,KAAK,EAAE,MAAM,EAAE,GAAG,EAAE,MAAM,EAAC,CAAC;;AAE5C,QAAI,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;;AAE3B,QAAI,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,IAAI,CAAC,OAAO,EAAE,MAAM,EAAE,aAAa,EAAE,QAAQ,CAAC,CAAC;;AAE3F,QAAI,OAAO,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;AACzB,QAAI,WAAW,GAAG,CAAC,OAAO,GAAG,SAAS,CAAA,GAAI,IAAI,CAAC;AAC/C,WAAO,CAAC,GAAG,CAAC,iBAAiB,EAAE,UAAU,EAAE,aAAa,EAAE,WAAW,CAAC,CAAC;;AAEvE,QAAI,IAAI,GAAG,UAAU,CAAC,QAAQ,EAAE,CAAC;AACjC,QAAI,IAAI,IAAI,CAAC,EAAE;AACb,aAAO,CAAC,GAAG,CAAC,YAAY,EAAE,IAAI,CAAC,CAAC;AAChC,UAAI,GAAG,GAAG,4BAA4B,CAAC;AACvC,cAAQ,CAAC,GAAG,CAAC,CAAC;AACd,aAAO;KACR;;AAED,QAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,eAAe,CAAC,OAAO,EAChD,MAAM,EACN,aAAa,EACb,QAAQ,EACR,CAAC,UAAS,GAAG,EAAE,MAAM,EAAE;AACrB,UAAI,IAAI,CAAC,KAAK,EACZ,OAAO,CAAC,GAAG,CAAC,uBAAuB,EAAE,MAAM,CAAC,CAAC;AAC/C,UAAI,GAAG,EAAE;AACP,gBAAQ,CAAC,GAAG,CAAC,CAAC;AACd,eAAO,CAAC,GAAG,CAAC,+BAA+B,EAAE,GAAG,CAAC,CAAC;AAClD,eAAO;OACR;;AAED,UAAI,CAAC,iBAAiB,CAAC,OAAO,EAAE,MAAM,EAAE,aAAa,EAAE,QAAQ,CAAC,CAAC;KAClE,CAAA,CAAE,IAAI,CAAC,IAAI,CAAC,CACd,CAAC;GACH,CAAC;;AAEF,MAAI,CAAC,iBAAiB,GAAG,UAAS,OAAO,EAAE,MAAM,EAAE,aAAa,EAAE,QAAQ,EAAE;AAC1E,QAAI,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,WAAW,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE,EAAE,EAAE,SAAS,EAAE,QAAQ,EAAE,OAAO,EAAE,QAAQ,EAAC,CAAC,CAAC;AACvG,cAAU,CAAC,KAAK,CAAC,UAAS,GAAG,EAAE,GAAG,EAAE;AAClC,UAAI;AACF,YAAI,GAAG,EAAE;AACP,kBAAQ,CAAC,GAAG,CAAC,CAAC;AACd,iBAAO,CAAC,GAAG,CAAC,sBAAsB,EAAE,GAAG,CAAC,CAAC;AACzC,iBAAO;SACR;;AAED,eAAO,CAAC,GAAG,CAAC,sBAAsB,EAAE,GAAG,CAAC,CAAC;;AAEzC,YAAI,SAAS,GAAG,GAAG,CAAC,IAAI,CAAC;AACzB,YAAI,QAAQ,GAAG,SAAS,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;AACzC,YAAI,QAAQ,GAAG,CAAC,EAAE;AAChB,kBAAQ,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC;SAC1B,MACI;AACH,kBAAQ,CAAC,4BAA4B,CAAC,CAAC;SACxC;OACF,SACO;AACN,eAAO,CAAC,GAAG,CAAC,4BAA4B,CAAC,CAAC;AAC1C,kBAAU,CAAC,YAAY,EAAE,CAAC;OAC3B;KACF,CAAC,CAAC;GACJ,CAAC;;AAEF,MAAI,CAAC,WAAW,GAAG,UAAS,QAAQ,EAAE,KAAK,EAAE,MAAM,EAAE,OAAO,EAAE,aAAa,EAAE,WAAW,EAAE,QAAQ,EAAE;AAClG,QAAI,QAAQ,GAAG,EAAC,GAAG,EAAE,OAAO,EAAC,CAAC;;AAE9B,QAAI,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;;AAE3B,QAAI,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,WAAW,CAAC,IAAI,CAAC,QAAQ,EAAE,KAAK,EAAE,MAAM,EAAE,OAAO,EAAE,aAAa,EAAE,WAAW,EAAE,QAAQ,CAAC,CAAC;;AAExH,QAAI,OAAO,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;AACzB,QAAI,WAAW,GAAG,CAAC,OAAO,GAAG,SAAS,CAAA,GAAI,IAAI,CAAC;AAC/C,WAAO,CAAC,GAAG,CAAC,mBAAmB,EAAE,UAAU,EAAE,aAAa,EAAE,WAAW,CAAC,CAAC;;AAEzE,QAAI,IAAI,GAAG,UAAU,CAAC,QAAQ,EAAE,CAAC;AACjC,YAAQ,IAAI;AACV,WAAK,QAAQ;AACX,eAAO,CAAC,GAAG,CAAC,iCAAiC,CAAC,CAAC;AAC/C,cAAM;AACR,WAAK,yBAAyB;;AAC5B,gBAAQ,CAAC,mBAAmB,GAAG,2CAA2C,CAAC,CAAC;AAC5E,eAAO;AAAA,AACT,WAAK,qBAAqB;;AACxB,gBAAQ,CAAC,sBAAsB,GAAG,mCAAmC,CAAC,CAAC;AACvE,eAAO;AAAA,AACT,WAAK,kBAAkB;;AACrB,gBAAQ,CAAC,sCAAsC,GAAG,oDAAoD,CAAC,CAAC;AACxG,eAAO;AAAA,AACT,WAAK,kBAAkB;;AACrB,gBAAQ,CAAC,yDAAyD,EAAE,EAAE,CAAC,CAAC;AACxE,eAAO;AAAA,AACT,WAAK,+BAA+B;;AAClC,gBAAQ,CAAC,kDAAkD,GAAG,qDAAqD,CAAC,CAAC;AACrH,eAAO;AAAA,AACT,WAAK,gBAAgB;AACnB,gBAAQ,CAAC,oDAAoD,GAAG,qBAAqB,CAAC,CAAC;AACvF,eAAO;AAAA,AACT,WAAK,yBAAyB;;AAC5B,gBAAQ,CAAC,4CAA4C,GAAG,+DAA+D,CAAC,CAAC;AACzH,eAAO;AAAA,AACT,WAAK,sBAAsB;AACzB,gBAAQ,CAAC,6CAA6C,GAAG,uDAAuD,CAAC,CAAC;AAClH,eAAO;AAAA,AACT;AACE,gBAAQ,CAAC,mBAAmB,GAAG,IAAI,CAAC,CAAC;AACrC,eAAO;AAAA,KACV;;;;;;;;AAQD,QAAI,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,WAAW,CAAC,EAAE,QAAQ,EAAE,QAAQ,EAAE,CAAC,CAAC;AACnE,cAAU,CAAC,KAAK,CAAC,UAAS,GAAG,EAAE,GAAG,EAAE;;;AAGlC,UAAI,GAAG,EAAE;AACP,eAAO,CAAC,GAAG,CAAC,sBAAsB,EAAE,GAAG,CAAC,CAAC;AACzC,gBAAQ,CAAC,GAAG,CAAC,CAAC;AACd,eAAO;OACR;;AAED,aAAO,CAAC,GAAG,CAAC,sBAAsB,EAAE,GAAG,CAAC,CAAC;;AAEzC,UAAI,SAAS,GAAG,GAAG,CAAC,IAAI,CAAC;AACzB,UAAI,SAAS,CAAC,IAAI,CAAC,QAAQ,EAAE,KAAK,QAAQ,EAAE;AAC1C,gBAAQ,CAAC,IAAI,EAAE,iBAAiB,GAAG,QAAQ,CAAC,CAAC;OAC9C,MACI;AACH,gBAAQ,CAAC,sBAAsB,GAAG,IAAI,CAAC,CAAC;OACzC;;AAED,gBAAU,CAAC,YAAY,EAAE,CAAC;KAC3B,CAAC,CAAC;;AAEH,QAAI,CAAC,QAAQ,CAAC,WAAW,CAAC,eAAe,CAAC,QAAQ,EAChD,KAAK,EACL,MAAM,EACN,OAAO,EACP,aAAa,EACb,WAAW,EACX,QAAQ,EACR,UAAS,GAAG,EAAE,MAAM,EAAE;AACpB,UAAI,IAAI,CAAC,KAAK,EACZ,OAAO,CAAC,GAAG,CAAC,sBAAsB,EAAE,MAAM,CAAC,CAAC;AAC9C,UAAI,GAAG,EAAE;AACP,gBAAQ,CAAC,GAAG,CAAC,CAAC;AACd,eAAO,CAAC,GAAG,CAAC,8BAA8B,EAAE,GAAG,CAAC,CAAC;AACjD,eAAO;OACR;KACF,CACF,CAAC;GACH,CAAC;;AAEF,MAAI,CAAC,aAAa,GAAG,UAAS,QAAQ,EAAE,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE;AAClE,QAAI,QAAQ,GAAG,EAAC,GAAG,EAAE,MAAM,EAAC,CAAC;;AAE7B,QAAI,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;;AAE3B,QAAI,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,aAAa,CAAC,IAAI,CAAC,QAAQ,EAAE,MAAM,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC;;AAExF,QAAI,OAAO,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;AACzB,QAAI,WAAW,GAAG,CAAC,OAAO,GAAG,SAAS,CAAA,GAAI,IAAI,CAAC;AAC/C,WAAO,CAAC,GAAG,CAAC,mBAAmB,EAAE,UAAU,EAAE,aAAa,EAAE,WAAW,CAAC,CAAC;;AAEzE,QAAI,IAAI,GAAG,UAAU,CAAC,QAAQ,EAAE,CAAC;AACjC,YAAQ,IAAI;AACV,WAAK,QAAQ;AACX,eAAO,CAAC,GAAG,CAAC,iCAAiC,CAAC,CAAC;AAC/C,cAAM;AACR,WAAK,yBAAyB;AAC5B,gBAAQ,CAAC,yBAAyB,CAAC,CAAC;AACpC,eAAO;AAAA,AACT,WAAK,gBAAgB;AACnB,gBAAQ,CAAC,0BAA0B,CAAC,CAAC;AACrC,eAAO;AAAA,AACT;AACE,eAAO,CAAC,GAAG,CAAC,yBAAyB,EAAE,IAAI,CAAC,CAAC;AAC7C,gBAAQ,CAAC,kBAAkB,GAAG,IAAI,CAAC,CAAC;AACpC,eAAO;AAAA,KACV;;;;;;AAMD,QAAI,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,WAAW,CAAC,EAAE,QAAQ,EAAE,QAAQ,EAAE,CAAC,CAAC;AACnE,cAAU,CAAC,KAAK,CAAC,UAAS,GAAG,EAAE,GAAG,EAAE;;;AAGlC,UAAI,GAAG,EAAE;AACP,eAAO,CAAC,GAAG,CAAC,sBAAsB,EAAE,GAAG,CAAC,CAAC;AACzC,gBAAQ,CAAC,GAAG,CAAC,CAAC;AACd,eAAO;OACR;;AAED,aAAO,CAAC,GAAG,CAAC,sBAAsB,EAAE,GAAG,CAAC,CAAC;;AAEzC,UAAI,SAAS,GAAG,GAAG,CAAC,IAAI,CAAC;AACzB,UAAI,SAAS,CAAC,IAAI,CAAC,QAAQ,EAAE,KAAK,QAAQ,EAAE;;AAE1C,gBAAQ,CAAC,IAAI,EAAE,kBAAkB,GAAG,QAAQ,CAAC,CAAC;OAC/C,MACI;AACH,gBAAQ,CAAC,wBAAwB,GAAG,IAAI,CAAC,CAAC;OAC3C;;AAED,gBAAU,CAAC,YAAY,EAAE,CAAC;KAC3B,CAAC,CAAC;;AAEH,QAAI,CAAC,QAAQ,CAAC,aAAa,CAAC,eAAe,CAAC,QAAQ,EAClD,MAAM,EACN,QAAQ,EACR,QAAQ,EACR,UAAS,GAAG,EAAE,MAAM,EAAE;AACpB,UAAI,IAAI,CAAC,KAAK,EACZ,OAAO,CAAC,GAAG,CAAC,wBAAwB,EAAE,MAAM,CAAC,CAAC;AAChD,UAAI,GAAG,EAAE;AACP,gBAAQ,CAAC,GAAG,CAAC,CAAC;AACd,eAAO,CAAC,GAAG,CAAC,gCAAgC,EAAE,GAAG,CAAC,CAAC;AACnD,eAAO;OACR;KACF,CACF,CAAC;GACH,CAAC;;;AAGF,MAAI,CAAC,cAAc,GAAG,UAAS,KAAK,EAAE,GAAG,EAAE;AACzC,QAAI,QAAQ,GAAG,EAAC,GAAG,EAAE,OAAO,EAAC,CAAC;AAC9B,QAAI,SAAS,GAAG,IAAI,CAAC,QAAQ,CAAC,cAAc,CAAC,IAAI,CAAC,KAAK,EAAE,GAAG,EAAE,QAAQ,CAAC,CAAC;;AAExE,QAAI,MAAM,GAAG,EAAE,CAAC;AAChB,QAAI,GAAG,GAAG,SAAS,CAAC,MAAM,CAAC;;AAE3B,SAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,GAAG,EAAE,CAAC,IAAI,aAAa,EAAE;;AAE3C,UAAI,KAAK,GAAG,SAAS,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;AAC7B,UAAI,eAAe,GAAG,SAAS,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;;AAEvC,YAAM,CAAC,IAAI,CAAC;AACV,gBAAQ,EAAE,SAAS,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,QAAQ,EAAE;AACrC,eAAO,EAAE,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;AACzC,gBAAQ,EAAE,KAAK,CAAC,QAAQ,EAAE;AAC1B,gBAAQ,EAAE,IAAI,CAAC,UAAU,CAAC,KAAK,EAAE,eAAe,CAAC;AACjD,sBAAc,EAAE,SAAS,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,QAAQ,EAAE;;;AAAA,OAG5C,CAAC,CAAC;KACJ;;AAED,WAAO,MAAM,CAAC;GACf,CAAC;;AAEF,MAAI,CAAC,YAAY,GAAG,UAAS,EAAE,EAAE,OAAO,EAAE,OAAO,EAAE;AACjD,QAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,EAAE,CAAA,UAAS,KAAK,EAAE,MAAM,EAAE;AAC1D,UAAI,KAAK,EAAE;AACT,eAAO,CAAC,uBAAuB,GAAG,EAAE,GAAG,IAAI,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC;AAC7D,eAAO;OACR;;;AAGD,aAAO,CAAC,GAAG,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;;AAE9B,UAAI,CAAC,MAAM,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE;AACzB,eAAO,CAAC,KAAK,CAAC,CAAC;AACf,eAAO;OACR;;AAED,UAAI,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;AACtB,UAAI,eAAe,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;;AAEhC,UAAI,MAAM,GAAG;AACX,UAAE,EAAE,EAAE;AACN,eAAO,EAAE,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;AAClC,cAAM,EAAE,KAAK,CAAC,QAAQ,EAAE;AACxB,aAAK,EAAE,IAAI,CAAC,UAAU,CAAC,KAAK,EAAE,eAAe,CAAC;AAC9C,cAAM,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE;AAC5B,eAAO,EAAE,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;AAC/B,cAAM,EAAE,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;OAC/B,CAAC;;AAEF,aAAO,CAAC,MAAM,CAAC,CAAC;KACjB,CAAA,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;GACf,CAAC;;AAEF,MAAI,CAAC,UAAU,GAAG,UAAS,KAAK,EAAE,eAAe,EAAE;AACjD,WAAO,KAAK,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;GAC9E,CAAC;;AAEF,MAAI,CAAC,SAAS,GAAG,UAAS,MAAM,EAAE;;AAChC,QAAI,UAAU,GAAG,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;AAC1C,WAAO,CAAC,GAAG,CAAC,YAAY,EAAE,UAAU,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;AAChD,WAAO,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;;GAE1C,CAAC;;;;AAIF,MAAI,CAAC,WAAW,GAAG,UAAS,EAAE,EAAE;AAC9B,WAAO,EAAE,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,EAAE,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,QAAQ,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;;;GAGvF,CAAC;;AAEF,MAAI,CAAC,MAAM,GAAG,UAAS,MAAM,EAAE;AAC7B,QAAI,IAAI,GAAG,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;AACpC,WAAO,IAAI,KAAK,GAAG,GAAG,EAAE,GAAG,IAAI,CAAC;GACjC,CAAC;;;;;;;;;;;;;;;;;;;;;;CAsBH,CAAC;;;;;;AAOF,MAAM,CAAC,OAAO,GAAG,OAAO,CAAC","file":"src/btcswap.js","sourcesContent":["var BigNumber = require('bignumber.js');\nvar bs58 = require('bs58');\nvar web3 = require('web3');\nvar abi = require('./abi');\n\nvar TWO_POW_256 = new BigNumber(2).pow(256);\n\nvar SATOSHI_PER_BTC = new BigNumber(10).pow(8);\n\nvar TICKET_FIELDS = 7;\n\nvar RESERVE_FAIL_UNRESERVABLE = -10;\nvar RESERVE_FAIL_POW = -11;\n\nvar CLAIM_FAIL_INVALID_TICKET = -20;\nvar CLAIM_FAIL_UNRESERVED = -21;\nvar CLAIM_FAIL_CLAIMER = -22;\nvar CLAIM_FAIL_TX_HASH = -23;\nvar CLAIM_FAIL_INSUFFICIENT_SATOSHI = -24;\nvar CLAIM_FAIL_PROOF = -25;\nvar CLAIM_FAIL_WRONG_BTC_ADDR = -26;\nvar CLAIM_FAIL_TX_ENCODING = -27;\n\nvar btcswap = function(params) {\n  if (!params.host) {\n    throw new Error('Web3 host missing');\n  }\n\n  if (!params.address) {\n    throw new Error('BTCswap address missing');\n  }\n\n  if (typeof params.btcTestnet === 'undefined')\n    this.btcTestnet = true;\n  else\n    this.btcTestnet = params.btcTestnet;\n\n  web3.setProvider(new web3.providers.HttpProvider('//' + params.host));\n\n  web3.eth.getCode(params.address, function(err, result) {\n    if (err) {\n      throw err;\n    }\n    if (result === '0x') {\n      throw new Error('BTCswap contract not found');\n    }\n  });\n\n  web3.eth.defaultAccount = params.from;\n\n  this.contract = web3.eth.contract(abi).at(params.address);\n  console.log('BTCswap contract: ', this.contract);\n\n  this.versionAddr = this.btcTestnet ? 111 : 0;\n\n  this.createTicket = function(btcAddress, numEther, btcPrice, callback) {\n    var addrHex;\n    try {\n      addrHex = '0x' + bs58.decode(btcAddress);\n      console.log(\"BTC address hex: \", addrHex);\n    }\n    catch (err) {\n      callback(new Error(btcAddress + ' is an invalid Bitcoin address: ' + err.message));\n      return;\n    }\n    var numWei = web3.toWei(numEther, 'ether');\n    var weiPerSatoshi = new BigNumber(numWei).div(SATOSHI_PER_BTC.mul(btcPrice)).round(0).toString(10);\n\n    var objParam = {value: numWei, gas: 500000};\n\n    var startTime = Date.now();\n\n    var callResult = this.contract.createTicket.call(addrHex, numWei, weiPerSatoshi, objParam);\n\n    var endTime = Date.now();\n    var durationSec = (endTime - startTime) / 1000;\n    console.log('@@@@ call res: ', callResult, ' duration: ', durationSec);\n\n    var rval = callResult.toNumber();\n    if (rval <= 0) {\n      console.log('@@@ rval: ', rval);\n      var msg = 'Offer could not be created';\n      callback(msg);\n      return;\n    }\n\n    this.contract.createTicket.sendTransaction(addrHex,\n      numWei,\n      weiPerSatoshi,\n      objParam,\n      (function(err, result) {\n        if (this.debug)\n          console.log(\"createTicket result: \", result);\n        if (err) {\n          callback(err);\n          console.log('@@@ createTicket sendtx err: ', err);\n          return;\n        }\n\n        this.watchCreateTicket(addrHex, numWei, weiPerSatoshi, callback);\n      }).bind(this)\n    );\n  };\n\n  this.watchCreateTicket = function(addrHex, numWei, weiPerSatoshi, callback) {\n    var rvalFilter = this.contract.ticketEvent({ ticketId: 0 }, { fromBlock: 'latest', toBlock: 'latest'});\n    rvalFilter.watch(function(err, res) {\n      try {\n        if (err) {\n          callback(err);\n          console.log('@@@ rvalFilter err: ', err);\n          return;\n        }\n\n        console.log('@@@ rvalFilter res: ', res);\n\n        var eventArgs = res.args;\n        var ticketId = eventArgs.rval.toNumber();\n        if (ticketId > 0) {\n          callback(null, ticketId);\n        }\n        else {\n          callback('Offer could not be created');\n        }\n      }\n      finally {\n        console.log('@@@ filter stopWatching...');\n        rvalFilter.stopWatching();\n      }\n    });\n  };\n\n  this.claimTicket = function(ticketId, txHex, txHash, txIndex, merkleSibling, txBlockHash, callback) {\n    var objParam = {gas: 3000000};\n\n    var startTime = Date.now();\n\n    var callResult = this.contract.claimTicket.call(ticketId, txHex, txHash, txIndex, merkleSibling, txBlockHash, objParam);\n\n    var endTime = Date.now();\n    var durationSec = (endTime - startTime) / 1000;\n    console.log('@@@@ callResult: ', callResult, ' duration: ', durationSec);\n\n    var rval = callResult.toNumber();\n    switch (rval) {\n      case ticketId:\n        console.log('@@@@ call GOOD so now sendTx...');\n        break;  // the only result that does not return;\n      case CLAIM_FAIL_INVALID_TICKET:  // one way to get here is Claim, mine, then Claim without refreshing the UI\n        callback('Invalid Ticket ID' + ' Ticket does not exist or already claimed');\n        return;\n      case CLAIM_FAIL_UNRESERVED:  // one way to get here is Reserve, let it expire, then Claim without refreshing the UI\n        callback('Ticket is unreserved' + ' Reserve the ticket and try again');\n        return;\n      case CLAIM_FAIL_CLAIMER:  // one way to get here is change web3.eth.defaultAccount\n        callback('Someone else has reserved the ticket' + ' You can only claim tickets that you have reserved');\n        return;\n      case CLAIM_FAIL_TX_HASH:  // should not happen since UI prevents it\n        callback('You need to use the transaction used in the reservation', '');\n        return;\n      case CLAIM_FAIL_INSUFFICIENT_SATOSHI:  // should not happen since UI prevents it\n        callback('Bitcoin transaction did not send enough bitcoins' + ' Number of bitcoins must meet ticket\\'s total price');\n        return;\n      case CLAIM_FAIL_PROOF:\n        callback('Bitcoin transaction needs at least 6 confirmations' + ' Wait and try again');\n        return;\n      case CLAIM_FAIL_WRONG_BTC_ADDR:  // should not happen since UI prevents it\n        callback('Bitcoin transaction paid wrong BTC address' + ' Bitcoins must be sent to the address specified by the ticket');\n        return;\n      case CLAIM_FAIL_TX_ENCODING:\n        callback('Bitcoin transaction incorrectly constructed' + ' Use btcToEther tool to construct bitcoin transaction');\n        return;\n      default:\n        callback('Unexpected error ' + rval);\n        return;\n    }\n\n    // callback(null, 'claimTicket eth_call succeeded'); return // for testing only\n\n    // at this point, the eth_call succeeded\n\n    // dbgVerifyTx();\n\n    var rvalFilter = this.contract.ticketEvent({ ticketId: ticketId });\n    rvalFilter.watch(function(err, res) {\n      // TODO try-finally\n      //\n      if (err) {\n        console.log('@@@ rvalFilter err: ', err);\n        callback(err);\n        return;\n      }\n\n      console.log('@@@ rvalFilter res: ', res);\n\n      var eventArgs = res.args;\n      if (eventArgs.rval.toNumber() === ticketId) {\n        callback(null, 'Ticket claimed ' + ticketId);\n      }\n      else {\n        callback('Claim ticket error: ' + rval);\n      }\n\n      rvalFilter.stopWatching();\n    });\n\n    this.contract.claimTicket.sendTransaction(ticketId,\n      txHex,\n      txHash,\n      txIndex,\n      merkleSibling,\n      txBlockHash,\n      objParam,\n      function(err, result) {\n        if (this.debug)\n          console.log(\"claimTicket result: \", result);\n        if (err) {\n          callback(err);\n          console.log('@@@ claimTicket sendtx err: ', err);\n          return;\n        }\n      }\n    );\n  };\n\n  this.reserveTicket = function(ticketId, txHash, powNonce, callback) {\n    var objParam = {gas: 500000};\n\n    var startTime = Date.now();\n\n    var callResult = this.contract.reserveTicket.call(ticketId, txHash, powNonce, objParam);\n\n    var endTime = Date.now();\n    var durationSec = (endTime - startTime) / 1000;\n    console.log('@@@@ callResult: ', callResult, ' duration: ', durationSec);\n\n    var rval = callResult.toNumber();\n    switch (rval) {\n      case ticketId:\n        console.log('@@@@ call GOOD so now sendTx...');\n        break;  // the only result that does not return\n      case RESERVE_FAIL_UNRESERVABLE:\n        callback('Ticket already reserved');\n        return;\n      case RESERVE_FAIL_POW:\n        callback('Proof of Work is invalid');\n        return;\n      default:\n        console.log('Unexpected error rval: ', rval);\n        callback('Unexpected error' + rval);\n        return;\n    }\n\n    // callback(null, 'reserveTicket eth_call succeeded'); return // for testing only\n\n    // at this point, the eth_call succeeded\n\n    var rvalFilter = this.contract.ticketEvent({ ticketId: ticketId });\n    rvalFilter.watch(function(err, res) {\n      // TODO try-finally\n      //\n      if (err) {\n        console.log('@@@ rvalFilter err: ', err);\n        callback(err);\n        return;\n      }\n\n      console.log('@@@ rvalFilter res: ', res);\n\n      var eventArgs = res.args;\n      if (eventArgs.rval.toNumber() === ticketId) {\n\n        callback(null, 'Ticket reserved ' + ticketId);\n      }\n      else {\n        callback('Reserve ticket error: ' + rval);\n      }\n\n      rvalFilter.stopWatching();\n    });\n\n    this.contract.reserveTicket.sendTransaction(ticketId,\n      txHash,\n      powNonce,\n      objParam,\n      function(err, result) {\n        if (this.debug)\n          console.log(\"reserveTicket result: \", result);\n        if (err) {\n          callback(err);\n          console.log('@@@ reserveTicket sendtx err: ', err);\n          return;\n        }\n      }\n    );\n  };\n\n  // returns tickets with keys ticketId, btcAddr, numEther, btcPrice, numClaimExpiry\n  this.getOpenTickets = function(start, end) {\n    var objParam = {gas: 3000000};\n    var ticketArr = this.contract.getOpenTickets.call(start, end, objParam);\n\n    var retArr = [];\n    var len = ticketArr.length;\n\n    for (var i = 0; i < len; i += TICKET_FIELDS) {\n\n      var bnWei = ticketArr[i + 2];\n      var bnWeiPerSatoshi = ticketArr[i + 3];\n\n      retArr.push({\n        ticketId: ticketArr[i + 0].toNumber(),\n        btcAddr: this.toBtcAddr(ticketArr[i + 1]), // toBtcAddr(ticketArr[i + 1], this.versionAddr),\n        numEther: bnWei.toString(), // toEther(bnWei),\n        btcPrice: this.toBtcPrice(bnWei, bnWeiPerSatoshi),\n        numClaimExpiry: ticketArr[i + 4].toNumber()\n        // bnClaimer: ticketArr[i + 5].toString(10),\n        // bnClaimTxHash: ticketArr[i + 6].toString(10)\n      });\n    }\n\n    return retArr;\n  };\n\n  this.lookupTicket = function(id, success, failure) {\n    this.contract.lookupTicket.call(id, function(error, result) {\n      if (error) {\n        failure(\"Error loading ticket \" + id + \": \" + String(error));\n        return;\n      }\n\n      // if (this.debug)\n      console.log(\"LOOKUP\", result);\n\n      if (!result || !result[0]) {\n        success(false);\n        return;\n      }\n\n      var bnWei = result[1];\n      var bnWeiPerSatoshi = result[2];\n\n      var ticket = {\n        id: id,\n        address: this.toBtcAddr(result[0]), // toBtcAddr(arr[0], this.versionAddr),\n        amount: bnWei.toString(), // toEther(bnWei),\n        price: this.toBtcPrice(bnWei, bnWeiPerSatoshi),\n        expiry: result[3].toNumber(),\n        claimer: this.toHash(result[4]),\n        txhash: this.toHash(result[5])\n      };\n\n      success(ticket);\n    }.bind(this));\n  };\n\n  this.toBtcPrice = function(bnWei, bnWeiPerSatoshi) {\n    return bnWei.div(bnWeiPerSatoshi).div(SATOSHI_PER_BTC).round(8).toString(10);\n  };\n\n  this.toBtcAddr = function(bignum) { // , versionAddr) {\n    var hexAddress = web3.fromDecimal(bignum);\n    console.log(\"hexAddress\", hexAddress.substr(2));\n    return bs58.encode(hexAddress.substr(2));\n    // return new Bitcoin.Address(Crypto.util.hexToBytes(btcAddr), versionAddr).toString();\n  };\n\n  // needed for handling negative bignums\n  // http://stackoverflow.com/questions/3417183/modulo-of-negative-numbers/3417242#3417242\n  this.bignumToHex = function(bn) {\n    return bn.mod(TWO_POW_256).lt(0) ? bn.add(TWO_POW_256).toString(16) : bn.toString(16);\n\n    // return bn.mod(TWO_POW_256).add(TWO_POW_256).mod(TWO_POW_256).toString(16);\n  };\n\n  this.toHash = function(bignum) {\n    var hash = this.bignumToHex(bignum);\n    return hash === '0' ? '' : hash;\n  };\n\n  // this.decodeBase58Check = function(btcAddr) {\n  //   var versionAndHash = Bitcoin.Address.decodeString(btcAddr);\n  //   var byteArrayData = versionAndHash.hash;\n  //\n  //   var ret = \"\",\n  //     i = 0,\n  //     len = byteArrayData.length;\n  //\n  //   while (i < len) {\n  //     var a = byteArrayData[i];\n  //     var h = a.toString(16);\n  //     if (a < 10) {\n  //       h = \"0\" + h;\n  //     }\n  //     ret += h;\n  //     i++;\n  //   }\n  //\n  //   return ret;\n  // };\n};\n\n\n// var toEther = function(bnWei) {\n//   return web3.fromWei(bnWei, 'ether').toString(10);\n// };\n\nmodule.exports = btcswap;\n\n// function dbgVerifyTx() {\n//   // TODO don't forget to update the ABI\n//   var dbgAddress = '0x90439a6495ee8e7d86a4acd2cbe649ed21e2ef6e';\n//   var dbgContract = web3.eth.contract(externaDebugVerifyTxAbi).at(dbgAddress);\n//\n//   var txHash = '0x558231b40b5fdddb132f9fcc8dd82c32f124b6139ecf839656f4575a29dca012';\n//   var dbgEvent = dbgContract.dbgEvent({ txHash: txHash });\n//\n//   var txhEvent = dbgContract.txhEvent({ txHash: txHash });\n//\n//\n//   dbgEvent.watch(function(err, res) {\n//     if (err) {\n//       console.log('@@@ dbgEvent err: ', err)\n//       return;\n//     }\n//\n//     console.log('@@@ dbgEvent res: ', res)\n//   });\n//\n//\n//   txhEvent.watch(function(err, res) {\n//     if (err) {\n//       console.log('@@@ txhEvent err: ', err)\n//       return;\n//     }\n//\n//     console.log('@@@ txhEvent res: ', res)\n//   });\n// }\n"]}