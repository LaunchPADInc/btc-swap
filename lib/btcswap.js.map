{"version":3,"sources":["src/btcswap.js"],"names":[],"mappings":"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","file":"src/btcswap.js","sourcesContent":["var BigNumber = require('bignumber.js');\nvar bitcoin = require('bitcoinjs-lib');\nvar web3 = require('web3');\nvar abi = require('./abi');\n\nvar ku = require('./keccak.js');\nvar bnTarget = new BigNumber(2).pow(234);\nvar kecc = new ku.Keccak();\n\nvar TWO_POW_256 = new BigNumber(2).pow(256);\n\nvar SATOSHI_PER_BTC = new BigNumber(10).pow(8);\n\nvar TICKET_FIELDS = 7;\n\nvar RESERVE_FAIL_UNRESERVABLE = -10;\nvar RESERVE_FAIL_POW = -11;\n\nvar CLAIM_FAIL_INVALID_TICKET = -20;\nvar CLAIM_FAIL_UNRESERVED = -21;\nvar CLAIM_FAIL_CLAIMER = -22;\nvar CLAIM_FAIL_TX_HASH = -23;\nvar CLAIM_FAIL_INSUFFICIENT_SATOSHI = -24;\nvar CLAIM_FAIL_PROOF = -25;\nvar CLAIM_FAIL_WRONG_BTC_ADDR = -26;\nvar CLAIM_FAIL_TX_ENCODING = -27;\n\nvar btcSwap = function(params) {\n  if (!params.host) {\n    throw new Error('Web3 host missing');\n  }\n\n  if (!params.address) {\n    throw new Error('BTCswap address missing');\n  }\n\n  if (typeof params.btcTestnet === 'undefined')\n    this.btcTestnet = true;\n  else\n    this.btcTestnet = params.btcTestnet;\n\n  web3.setProvider(new web3.providers.HttpProvider('http://' + params.host));\n\n  web3.eth.getCode(params.address, function(err, result) {\n    if (err) {\n      throw err;\n    }\n    if (result === '0x') {\n      throw new Error('BTCswap contract not found');\n    }\n  });\n\n  web3.eth.defaultAccount = params.from;\n\n  this.debug = params.debug;\n\n  this.contract = web3.eth.contract(abi).at(params.address);\n\n  if (this.debug)\n    console.log('BTCswap contract: ', this.contract);\n\n  this.versionAddr = this.btcTestnet ? 111 : 0;\n\n\n  this.createTicket = function(btcAddress, numEther, btcPrice, success, failure) {\n    var addrHex;\n    try {\n      addrHex = '0x' + bitcoin.Address.fromBase58Check(btcAddress).toString('hex');\n      if (this.debug)\n        console.log(\"BTC address hex: \", addrHex);\n    }\n    catch (err) {\n      failure(new Error(btcAddress + ' is an invalid Bitcoin address: ' + err.message));\n      return;\n    }\n    var numWei = web3.toWei(numEther, 'ether');\n    var weiPerSatoshi = new BigNumber(numWei).div(SATOSHI_PER_BTC.mul(btcPrice)).round(0).toString(10);\n\n    var objParam = {value: numWei, gas: 500000};\n\n    var startTime = Date.now();\n\n    var callResult = this.contract.createTicket.call(addrHex, numWei, weiPerSatoshi, objParam);\n\n    var endTime = Date.now();\n    var durationSec = (endTime - startTime) / 1000;\n    if (this.debug)\n      console.log('Call result: ', callResult, ' duration: ', durationSec);\n\n    var rval = callResult.toNumber();\n    if (rval <= 0) {\n      if (this.debug)\n        console.log('Return value: ', rval);\n      var msg = 'Offer could not be created';\n      failure(msg);\n      return;\n    }\n\n    this.contract.createTicket.sendTransaction(addrHex,\n      numWei,\n      weiPerSatoshi,\n      objParam,\n      (function(err, result) {\n        if (this.debug)\n          console.log(\"createTicket result: \", result);\n        if (err) {\n          failure(err);\n          console.log('@@@ createTicket sendtx err: ', err);\n          return;\n        }\n\n        this.watchCreateTicket(addrHex, numWei, weiPerSatoshi, success, failure);\n      }).bind(this)\n    );\n  };\n\n  this.watchCreateTicket = function(addrHex, numWei, weiPerSatoshi, success, failure) {\n    var rvalFilter = this.contract.ticketEvent({ ticketId: 0 }, { fromBlock: 'latest', toBlock: 'latest'});\n    rvalFilter.watch(function(err, res) {\n      try {\n        if (err) {\n          failure(err);\n          if (this.debug)\n            console.log('@@@ rvalFilter err: ', err);\n          return;\n        }\n\n        if (this.debug)\n          console.log('@@@ rvalFilter res: ', res);\n\n        var eventArgs = res.args;\n        var ticketId = eventArgs.rval.toNumber();\n        if (ticketId > 0) {\n          success(null, ticketId);\n        }\n        else {\n          failure('Offer could not be created');\n        }\n      }\n      finally {\n        if (this.debug)\n          console.log('@@@ filter stopWatching...');\n        rvalFilter.stopWatching();\n      }\n    });\n  };\n\n  this.claimTicket = function(ticketId, txHex, txHash, txIndex, merkleSibling, txBlockHash, success, failure) {\n    var objParam = {gas: 3000000};\n\n    var startTime = Date.now();\n\n    var callResult = this.contract.claimTicket.call(ticketId, txHex, txHash, txIndex, merkleSibling, txBlockHash, objParam);\n\n    var endTime = Date.now();\n    var durationSec = (endTime - startTime) / 1000;\n    if (this.debug)\n      console.log('@@@@ callResult: ', callResult, ' duration: ', durationSec);\n\n    var rval = callResult.toNumber();\n    switch (rval) {\n      case ticketId:\n        if (this.debug)\n          console.log('@@@@ call GOOD so now sendTx...');\n        break;  // the only result that does not return;\n      case CLAIM_FAIL_INVALID_TICKET:  // one way to get here is Claim, mine, then Claim without refreshing the UI\n        failure('Invalid Ticket ID' + ' Ticket does not exist or already claimed');\n        return;\n      case CLAIM_FAIL_UNRESERVED:  // one way to get here is Reserve, let it expire, then Claim without refreshing the UI\n        failure('Ticket is unreserved' + ' Reserve the ticket and try again');\n        return;\n      case CLAIM_FAIL_CLAIMER:  // one way to get here is change web3.eth.defaultAccount\n        failure('Someone else has reserved the ticket' + ' You can only claim tickets that you have reserved');\n        return;\n      case CLAIM_FAIL_TX_HASH:  // should not happen since UI prevents it\n        failure('You need to use the transaction used in the reservation', '');\n        return;\n      case CLAIM_FAIL_INSUFFICIENT_SATOSHI:  // should not happen since UI prevents it\n        failure('Bitcoin transaction did not send enough bitcoins' + ' Number of bitcoins must meet ticket\\'s total price');\n        return;\n      case CLAIM_FAIL_PROOF:\n        failure('Bitcoin transaction needs at least 6 confirmations' + ' Wait and try again');\n        return;\n      case CLAIM_FAIL_WRONG_BTC_ADDR:  // should not happen since UI prevents it\n        failure('Bitcoin transaction paid wrong BTC address' + ' Bitcoins must be sent to the address specified by the ticket');\n        return;\n      case CLAIM_FAIL_TX_ENCODING:\n        failure('Bitcoin transaction incorrectly constructed' + ' Use btcToEther tool to construct bitcoin transaction');\n        return;\n      default:\n        failure('Unexpected error ' + rval);\n        return;\n    }\n\n    // callback(null, 'claimTicket eth_call succeeded'); return // for testing only\n\n    // at this point, the eth_call succeeded\n\n    // dbgVerifyTx();\n\n    var rvalFilter = this.contract.ticketEvent({ ticketId: ticketId });\n    rvalFilter.watch(function(err, res) {\n      // TODO try-finally\n      //\n      if (err) {\n        if (this.debug)\n          console.log('@@@ rvalFilter err: ', err);\n        failure(err);\n        return;\n      }\n\n      console.log('@@@ rvalFilter res: ', res);\n\n      var eventArgs = res.args;\n      if (eventArgs.rval.toNumber() === ticketId) {\n        if (this.debug)\n          console.log('Ticket claimed: ', ticketId);\n      }\n      else {\n        failure('Claim ticket error: ' + rval);\n      }\n\n      rvalFilter.stopWatching();\n    });\n\n    this.contract.claimTicket.sendTransaction(ticketId,\n      txHex,\n      txHash,\n      txIndex,\n      merkleSibling,\n      txBlockHash,\n      objParam,\n      function(err, result) {\n        if (this.debug)\n          console.log(\"claimTicket result: \", result);\n        if (err) {\n          failure(err);\n          if (this.debug)\n            console.log('@@@ claimTicket sendtx err: ', err);\n          return;\n        }\n        success(result);\n      }\n    );\n  };\n\n  this.reserveTicket = function(ticketId, txHash, powNonce, success, failure, completed) {\n    var objParam = {gas: 500000};\n\n    var startTime = Date.now();\n\n    this.contract.reserveTicket.call(ticketId, txHash, powNonce, objParam, function(error, result) {\n      if (error) {\n        failure(error);\n        return;\n      }\n\n      var endTime = Date.now();\n      var durationSec = (endTime - startTime) / 1000;\n      if (this.debug)\n        console.log('reserveTicket call:', result.toNumber(), ' duration:', durationSec);\n\n      var rval = result.toNumber();\n      switch (rval) {\n        case ticketId:\n          if (this.debug)\n            console.log('reserveTicket call looks good, now sending transaction...');\n          break;  // the only result that does not return\n        case RESERVE_FAIL_UNRESERVABLE:\n          failure('Ticket already reserved');\n          return;\n        case RESERVE_FAIL_POW:\n          failure('Proof of Work is invalid');\n          return;\n        default:\n          if (this.debug)\n            console.log('Unexpected error:', rval);\n          failure('Unexpected error: ' + rval);\n          return;\n      }\n\n      // at this point, the eth_call succeeded\n      if (this.debug)\n        return;\n\n      var reserveFilter = this.contract.ticketEvent({ ticketId: ticketId });\n      reserveFilter.watch(function(err, res) {\n        try {\n          if (err) {\n            if (this.debug)\n              console.log('reserveFilter error: ', err);\n            failure(err);\n            return;\n          }\n\n          if (this.debug)\n            console.log('reserveFilter result: ', res);\n\n          var eventArgs = res.args;\n          if (eventArgs.rval.toNumber() === ticketId) {\n            if (this.debug)\n              console.log('Ticket reserved: ', ticketId);\n            completed(ticketId);\n          }\n          else {\n            failure('Reserve ticket error: ' + rval);\n          }\n        }\n        finally {\n          if (this.debug)\n            console.log('reserveFilter.stopWatching()...');\n          reserveFilter.stopWatching();\n        }\n      });\n\n      this.contract.reserveTicket.sendTransaction(ticketId, txHash, powNonce, objParam, function(err, res) {\n        if (this.debug)\n          console.log(\"reserveTicket result: \", res);\n        if (err) {\n          failure(err);\n          if (this.debug)\n            console.log('reserveTicket sendTx error: ', err);\n          return;\n        }\n        success(res);\n      });\n    }.bind(this));\n  };\n\n  // returns tickets with keys ticketId, btcAddr, numEther, btcPrice, numClaimExpiry\n  this.getOpenTickets = function(start, end, success, failure) {\n    var ticketArr = this.contract.getOpenTickets.call(start, end, function(error, result) {\n      if (error) {\n        failure(error);\n        return;\n      }\n\n      var results = [];\n      var len = ticketArr.length;\n\n      for (var i = 0; i < len; i += TICKET_FIELDS) {\n\n        var bnWei = result[i + 2];\n        var bnWeiPerSatoshi = result[i + 3];\n\n        results.push({\n          ticketId: result[i + 0].toNumber(),\n          btcAddr: this.toBtcAddr(result[i + 1]), // toBtcAddr(ticketArr[i + 1], this.versionAddr),\n          numEther: bnWei.toString(), // toEther(bnWei),\n          btcPrice: this.toBtcPrice(bnWei, bnWeiPerSatoshi),\n          numClaimExpiry: result[i + 4].toNumber()\n          // bnClaimer: ticketArr[i + 5].toString(10),\n          // bnClaimTxHash: ticketArr[i + 6].toString(10)\n        });\n      }\n      success(results);\n    });\n  };\n\n  this.lookupTicket = function(id, success, failure) {\n    this.contract.lookupTicket.call(id, function(error, result) {\n      if (error) {\n        failure(\"Error loading ticket \" + id + \": \" + String(error));\n        return;\n      }\n\n      // if (this.debug)\n      console.log(\"LOOKUP\", result);\n\n      if (!result || !result[0]) {\n        success(false);\n        return;\n      }\n\n      var bnWei = result[1];\n      var bnWeiPerSatoshi = result[2];\n\n      var ticket = {\n        id: id,\n        address: this.toBtcAddr(result[0]), // toBtcAddr(arr[0], this.versionAddr),\n        amount: bnWei.toString(), // toEther(bnWei),\n        price: this.toBtcPrice(bnWei, bnWeiPerSatoshi),\n        expiry: result[3].toNumber(),\n        claimer: this.toHash(result[4]),\n        txhash: this.toHash(result[5])\n      };\n\n      success(ticket);\n    }.bind(this));\n  };\n\n  this.toBtcPrice = function(bnWei, bnWeiPerSatoshi) {\n    return bnWei.div(bnWeiPerSatoshi).div(SATOSHI_PER_BTC).round(8).toString(10);\n  };\n\n  this.toBtcAddr = function(bignum) {\n    var hexAddress = web3.fromDecimal(bignum).substr(2);\n    if (this.debug)\n      console.log('hexAddress ', hexAddress, ' versionbyte: ', this.versionAddr);\n    return new bitcoin.Address(new Buffer(hexAddress, 'hex'), this.versionAddr).toString();\n  };\n\n  // needed for handling negative bignums\n  // http://stackoverflow.com/questions/3417183/modulo-of-negative-numbers/3417242#3417242\n  this.bignumToHex = function(bn) {\n    return bn.mod(TWO_POW_256).lt(0) ? bn.add(TWO_POW_256).toString(16) : bn.toString(16);\n\n    // return bn.mod(TWO_POW_256).add(TWO_POW_256).mod(TWO_POW_256).toString(16);\n  };\n\n  this.toHash = function(bignum) {\n    var hash = this.bignumToHex(bignum);\n    return hash === '0' ? '' : hash;\n  };\n\n  this.verifyPoWClicked = function(ticketId, txHash, nonce, success, failure) {\n    var hexTicketId = new BigNumber(ticketId).toString(16);\n    var padLen = 16 - hexTicketId.length;\n    var leadZerosForTicketId = Array(padLen + 1).join('0');\n\n    var hexNonce = new BigNumber(nonce).toString(16);\n    padLen = 16 - hexNonce.length;\n    var leadZerosForNonce = Array(padLen + 1).join('0');\n\n    var bnSrc = new BigNumber('0x' + txHash + leadZerosForTicketId + hexTicketId + leadZerosForNonce + hexNonce);\n    var src;\n    var bnHash;\n    var strHash;\n\n    if (this.debug)\n      console.log('@@@ bnSrc: ', bnSrc.toString(16));\n\n    src = ku.hexStringToBytes(bnSrc.toString(16));\n    src = new Uint32Array(src.buffer);\n    var srcLen = src.length;\n    var dst = new Uint32Array(8);\n    kecc.digestWords(dst, 0, 8, src, 0, srcLen);\n\n    strHash = ku.wordsToHexString(dst);\n    bnHash = new BigNumber('0x' + strHash);\n\n    var isPowValid = bnHash.lt(bnTarget);\n    if (this.debug)\n      console.log('@@@ isPowValid: ', isPowValid, ' pow: ', bnHash.toString(16), ' target: ', bnTarget.toString(16));\n\n    if (isPowValid) {\n      success('Proof of Work valid');\n    }\n    else {\n      failure('Proof of Work invalid');\n    }\n  };\n\n  this.computePoW = function(ticketId, btcTxHash, success, failure) {\n    try {\n      var powPromise = new Promise(function(resolve, reject) {\n        if (this.debug)\n          console.log('@@@ computePow txhash: ', btcTxHash);\n\n        var hexTicketId = new BigNumber(ticketId).toString(16);\n        var padLen = 8 - hexTicketId.length;\n        var leadZerosForTicketId = Array(padLen + 1).join('0');\n\n        var bnSrc = new BigNumber('0x' + btcTxHash + leadZerosForTicketId + hexTicketId + \"0000000000000000\");\n        var src;\n        var bnHash;\n        var strHash;\n\n        if (this.debug)\n          console.log('@@@ bnSrc: ', bnSrc.toString(16));\n\n\n        src = ku.hexStringToBytes(bnSrc.toString(16));\n        src = new Uint32Array(src.buffer);\n        var srcLen = src.length;\n        var dst = new Uint32Array(8);\n        kecc.digestWords(dst, 0, 8, src, 0, srcLen);\n\n        strHash = ku.wordsToHexString(dst);\n        bnHash = new BigNumber('0x' + strHash);\n\n\n        var startTime = new Date().getTime();\n        if (this.debug)\n          console.log(\"startTime: \", startTime);\n\n        var start = 0;\n        var tryPoW = function(i) {\n          bnSrc = bnSrc.add(1);\n\n          src = ku.hexStringToBytes(bnSrc.toString(16));\n          src = new Uint32Array(src.buffer);\n          kecc.digestWords(dst, 0, 8, src, 0, srcLen);\n\n          strHash = ku.wordsToHexString(dst);\n          bnHash = new BigNumber('0x' + strHash);\n          if (this.debug)\n            console.log(\"PASS\", i, strHash, bnHash.toString());\n\n          if (i >= 100000000)\n            reject(\"PoW failed.\");\n\n          i += 1;\n          if (bnHash.gte(bnTarget) && i < 100000000)\n            setTimeout(tryPoW, 10, i);\n          else\n            resolve(i);\n        }.bind(this);\n\n        tryPoW(start);\n\n        // var i = 0;\n        // while (bnHash.gte(bnTarget) && i < 100000000) {\n        //   setTimeout(tryPoW(i), 1);\n        //   i += 1;\n        // }\n\n        // if (i === 100000000)\n        //   reject(\"PoW failed.\");\n\n        if (this.debug) {\n          console.log(\"endTime: \", new Date().getTime());\n          console.log(\"duration: \", (new Date().getTime() - startTime) / 1000.0);\n\n          // console.log('@@@@ i: ', i);\n          console.log('@@@ strHash: ', strHash);\n        }\n\n        // resolve(i);\n      }.bind(this));\n\n      powPromise.then(function (nonce) {\n          success(nonce);\n      }, function (e) {\n          failure(String(e));\n      });\n    }\n    catch(e) {\n      failure(e);\n    }\n  };\n\n};\n\n\n// var toEther = function(bnWei) {\n//   return web3.fromWei(bnWei, 'ether').toString(10);\n// };\n\nmodule.exports = btcSwap;\n\n// function dbgVerifyTx() {\n//   // TODO don't forget to update the ABI\n//   var dbgAddress = '0x90439a6495ee8e7d86a4acd2cbe649ed21e2ef6e';\n//   var dbgContract = web3.eth.contract(externaDebugVerifyTxAbi).at(dbgAddress);\n//\n//   var txHash = '0x558231b40b5fdddb132f9fcc8dd82c32f124b6139ecf839656f4575a29dca012';\n//   var dbgEvent = dbgContract.dbgEvent({ txHash: txHash });\n//\n//   var txhEvent = dbgContract.txhEvent({ txHash: txHash });\n//\n//\n//   dbgEvent.watch(function(err, res) {\n//     if (err) {\n//       console.log('@@@ dbgEvent err: ', err)\n//       return;\n//     }\n//\n//     console.log('@@@ dbgEvent res: ', res)\n//   });\n//\n//\n//   txhEvent.watch(function(err, res) {\n//     if (err) {\n//       console.log('@@@ txhEvent err: ', err)\n//       return;\n//     }\n//\n//     console.log('@@@ txhEvent res: ', res)\n//   });\n// }\n"]}