{"version":3,"sources":["src/btc-swap.js"],"names":[],"mappings":"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","file":"src/btc-swap.js","sourcesContent":["var BigNumber = require('bignumber.js');\nvar bitcoin = require('bitcoinjs-lib');\nvar btcproof = require('bitcoin-proof');\nvar web3 = require('web3');\nvar abi = require('./abi');\nvar debugAbi = require('./debugAbi');\n\nvar ku = require('./keccak.js');\nvar bnTarget = new BigNumber(2).pow(234);\nvar kecc = new ku.Keccak();\n\nvar TWO_POW_256 = new BigNumber(2).pow(256);\n\nvar WEI_PER_ETHER = new BigNumber(10).pow(18);\nvar SATOSHI_PER_BTC = new BigNumber(10).pow(8);\n\nvar TICKET_FIELDS = 7;\n\nvar RESERVE_FAIL_UNRESERVABLE = -10;\nvar RESERVE_FAIL_POW = -11;\n\nvar CLAIM_FAIL_INVALID_TICKET = -20;\nvar CLAIM_FAIL_UNRESERVED = -21;\nvar CLAIM_FAIL_CLAIMER = -22;\nvar CLAIM_FAIL_TX_HASH = -23;\nvar CLAIM_FAIL_INSUFFICIENT_SATOSHI = -24;\nvar CLAIM_FAIL_PROOF = -25;\nvar CLAIM_FAIL_WRONG_BTC_ADDR = -26;\nvar CLAIM_FAIL_TX_ENCODING = -27;\n\nvar btcSwap = function(params) {\n  // Check parameters\n  if (!params.host) {\n    throw new Error('Web3 host missing');\n  }\n  if (!params.address) {\n    throw new Error('BtcSwap address missing');\n  }\n  if (typeof params.btcTestnet === 'undefined')\n    this.btcTestnet = true;\n  else\n    this.btcTestnet = params.btcTestnet;\n\n  // Set web3 provider\n  web3.setProvider(new web3.providers.HttpProvider('http://' + params.host));\n\n  // Check contract is available\n  web3.eth.getCode(params.address, function(err, result) {\n    if (err) {\n      throw err;\n    }\n    if (result === '0x') {\n      throw new Error('BtcSwap contract not found');\n    }\n  });\n\n  // Set defaultAccount for transactions\n  web3.eth.defaultAccount = params.from;\n\n  // Set debug flag\n  this.debug = params.debug;\n\n  // Load contract instance\n  this.contract = web3.eth.contract(abi).at(params.address);\n\n  if (this.debug)\n    console.log('BTCswap contract:', this.contract);\n\n  this.versionAddr = this.btcTestnet ? 111 : 0;\n\n\n  this.createTicket = function(btcAddress, numEther, btcTotal, success, completed, failure) {\n    var addrHex;\n    try {\n      addrHex = '0x' + bitcoin.Address.fromBase58Check(btcAddress).hash.toString('hex');\n      if (this.debug)\n        console.log(\"BTC address hex:\", addrHex);\n    }\n    catch (err) {\n      failure(new Error(btcAddress + ' is an invalid Bitcoin address: ' + err.message));\n      return;\n    }\n    var numWei = web3.toWei(numEther, 'ether');\n    var weiPerSatoshi = new BigNumber(numWei).div(SATOSHI_PER_BTC.mul(btcTotal)).round(0).toString(10);\n\n    var objParam = {value: numWei, gas: 500000};\n\n    var startTime = Date.now();\n\n    this.contract.createTicket.call(addrHex, numWei, weiPerSatoshi, objParam, function(error, result) {\n\n      var endTime = Date.now();\n      var durationSec = (endTime - startTime) / 1000;\n      if (this.debug)\n        console.log('Call result:', result, 'duration:', durationSec);\n\n      var rval = result.toNumber();\n      if (rval <= 0) {\n        if (this.debug)\n          console.log('Return value:', rval);\n        var msg = 'Invalid ticket, it will not be created.';\n        failure(msg);\n        return;\n      }\n\n      this.contract.createTicket.sendTransaction(addrHex, numWei, weiPerSatoshi, objParam, function(err, res) {\n        if (this.debug)\n          console.log(\"createTicket result:\", res);\n\n        if (err) {\n          failure(err);\n          console.log('createTicket sendTx error:', err);\n          return;\n        }\n\n        success(res);\n\n        this.watchCreateTicket(addrHex, numWei, weiPerSatoshi, res, completed, failure);\n      }.bind(this));\n    }.bind(this));\n  };\n\n  this.watchCreateTicket = function(addrHex, numWei, weiPerSatoshi, pendingHash, completed, failure) {\n    var createFilter = this.contract.ticketEvent({ ticketId: 0 }, { fromBlock: 'latest', toBlock: 'latest'});\n\n    createFilter.watch(function(err, res) {\n      try {\n        if (err) {\n          failure(err);\n          if (this.debug)\n            console.log('createFilter error:', err);\n          return;\n        }\n\n        if (this.debug)\n          console.log('createFilter result:', res);\n\n        var eventArgs = res.args;\n        var ticketId = eventArgs.rval.toNumber();\n        if (ticketId > 0) {\n          setTimeout( function() {\n            this.lookupTicket(ticketId, function(ticket) {\n              completed(pendingHash, ticket);\n            }, function(error) {\n              failure('Could not lookup created ticket: ' + error);\n            });\n          }.bind(this), 1000);\n        }\n        else {\n          failure('Ticket could not be created.');\n        }\n      }\n      finally {\n        if (this.debug)\n          console.log('createFilter.stopWatching()...');\n        createFilter.stopWatching();\n      }\n    }.bind(this));\n  };\n\n  this.claimTicket = function(ticketId, txHex, txHash, txIndex, merkleSibling, txBlockHash, success, completed, failure) {\n    var objParam = {gas: 3000000};\n\n    var startTime = Date.now();\n\n    this.contract.claimTicket.call(ticketId, txHex, txHash, txIndex, merkleSibling, txBlockHash, objParam, function(error, result) {\n      if (error) {\n        failure(error);\n        return;\n      }\n\n      var endTime = Date.now();\n      var durationSec = (endTime - startTime) / 1000;\n      if (this.debug)\n        console.log('claimTicket call:', result, ' duration:', durationSec);\n\n      var rval = result.toNumber();\n      switch (rval) {\n        case ticketId:\n          if (this.debug)\n            console.log('claimTicket call looks good, now sending transaction...');\n          break;  // the only result that does not return;\n        case CLAIM_FAIL_INVALID_TICKET:  // one way to get here is Claim, mine, then Claim without refreshing the UI\n          failure('Invalid Ticket ID' + ' Ticket does not exist or already claimed');\n          return;\n        case CLAIM_FAIL_UNRESERVED:  // one way to get here is Reserve, let it expire, then Claim without refreshing the UI\n          failure('Ticket is unreserved' + ' Reserve the ticket and try again');\n          return;\n        case CLAIM_FAIL_CLAIMER:  // one way to get here is change web3.eth.defaultAccount\n          failure('Someone else has reserved the ticket' + ' You can only claim tickets that you have reserved');\n          return;\n        case CLAIM_FAIL_TX_HASH:  // should not happen since UI prevents it\n          failure('You need to use the transaction used in the reservation', '');\n          return;\n        case CLAIM_FAIL_INSUFFICIENT_SATOSHI:  // should not happen since UI prevents it\n          failure('Bitcoin transaction did not send enough bitcoins' + ' Number of bitcoins must meet ticket\\'s total price');\n          return;\n        case CLAIM_FAIL_PROOF:\n          failure('Bitcoin transaction needs at least 6 confirmations' + ' Wait and try again');\n          return;\n        case CLAIM_FAIL_WRONG_BTC_ADDR:  // should not happen since UI prevents it\n          failure('Bitcoin transaction paid wrong BTC address' + ' Bitcoins must be sent to the address specified by the ticket');\n          return;\n        case CLAIM_FAIL_TX_ENCODING:\n          failure('Bitcoin transaction incorrectly constructed' + ' Use btcToEther tool to construct bitcoin transaction');\n          return;\n        default:\n          failure('Unexpected error ' + rval);\n          return;\n      }\n\n      // callback(null, 'claimTicket eth_call succeeded'); return // for testing only\n\n      // at this point, the eth_call succeeded\n\n      // dbgVerifyTx();\n\n      var claimFilter = this.contract.ticketEvent({ ticketId: ticketId });\n      claimFilter.watch(function(err, res) {\n        try {\n          if (err) {\n            if (this.debug)\n              console.log('claimFilter error: ', err);\n            failure(err);\n            return;\n          }\n\n          console.log('claimFilter result:', res);\n\n          var eventArgs = res.args;\n          if (eventArgs.rval.toNumber() === ticketId) {\n            if (this.debug)\n              console.log('Ticket claimed:', ticketId);\n            completed(res);\n          }\n          else {\n            failure('Claim ticket error: ' + rval);\n          }\n        }\n        finally {\n          if (this.debug)\n            console.log('claimFilter.stopWatching()...');\n          claimFilter.stopWatching();\n        }\n      }.bind(this));\n\n      this.contract.claimTicket.sendTransaction(ticketId, txHex, txHash, txIndex, merkleSibling, txBlockHash, objParam, function(err, res) {\n          if (this.debug)\n            console.log(\"claimTicket result: \", res);\n          if (err) {\n            failure(err);\n            if (this.debug)\n              console.log('claimTicket sendTx error: ', err);\n            return;\n          }\n          success(res);\n      }.bind(this));\n    }.bind(this));\n  };\n\n  this.reserveTicket = function(ticketId, txHash, powNonce, success, completed, failure) {\n    var objParam = {gas: 500000};\n\n    var startTime = Date.now();\n\n    this.contract.reserveTicket.call(ticketId, txHash, powNonce, objParam, function(error, result) {\n      if (error) {\n        failure(error);\n        return;\n      }\n\n      var endTime = Date.now();\n      var durationSec = (endTime - startTime) / 1000;\n      if (this.debug)\n        console.log('reserveTicket call:', result.toNumber(), ' duration:', durationSec);\n\n      var rval = result.toNumber();\n      switch (rval) {\n        case ticketId:\n          if (this.debug)\n            console.log('reserveTicket call looks good, now sending transaction...');\n          break;  // the only result that does not return\n        case RESERVE_FAIL_UNRESERVABLE:\n          failure('Ticket already reserved');\n          return;\n        case RESERVE_FAIL_POW:\n          failure('Proof of Work is invalid');\n          return;\n        default:\n          if (this.debug)\n            console.log('Unexpected error:', rval);\n          failure('Unexpected error: ' + rval);\n          return;\n      }\n\n      // at this point, the eth_call succeeded\n      // if (this.debug)\n      //   return;\n\n      var reserveFilter = this.contract.ticketEvent({ ticketId: ticketId });\n      reserveFilter.watch(function(err, res) {\n        try {\n          if (err) {\n            if (this.debug)\n              console.log('reserveFilter error:', err);\n            failure(err);\n            return;\n          }\n\n          if (this.debug)\n            console.log('reserveFilter result:', res);\n\n          var eventArgs = res.args;\n          if (eventArgs.rval.toNumber() === ticketId) {\n            if (this.debug)\n              console.log('Ticket reserved:', ticketId);\n            this.lookupTicket(ticketId, function(ticket) {\n              completed(ticket);\n            }, function(lookupError) {\n              failure('Could not lookup reserved ticket: ' + lookupError);\n            });\n          }\n          else {\n            failure('Reserve ticket error: ' + rval);\n          }\n        }\n        finally {\n          if (this.debug)\n            console.log('reserveFilter.stopWatching()...');\n          reserveFilter.stopWatching();\n        }\n      }.bind(this));\n\n      this.contract.reserveTicket.sendTransaction(ticketId, txHash, powNonce, objParam, function(err, res) {\n        if (this.debug)\n          console.log('reserveTicket result:', res);\n        if (err) {\n          failure(err);\n          if (this.debug)\n            console.log('reserveTicket sendTx error:', err);\n          return;\n        }\n        success({\n          id: ticketId,\n          hash: res\n        });\n      }.bind(this));\n    }.bind(this));\n  };\n\n  // returns tickets with keys ticketId, btcAddr, numEther, btcTotal, numClaimExpiry\n  this.getOpenTickets = function(start, end, success, failure) {\n    this.contract.getOpenTickets.call(start, end, function(error, results) {\n      if (error) {\n        failure(error);\n        return;\n      }\n\n      var tickets = [];\n\n      for (var i = 0; i < results.length; i += TICKET_FIELDS) {\n\n        var bnWei = results[i + 2];\n        var bnWeiPerSatoshi = results[i + 3];\n\n        tickets.push({\n          id: results[i + 0].toNumber(),\n          address: this.toBtcAddr(results[i + 1]),\n          amount: bnWei.toString(),\n          price: this.toBtcPrice(bnWeiPerSatoshi),\n          total: this.toBtcTotal(bnWei, bnWeiPerSatoshi),\n          expiry: results[i + 4].toNumber(),\n          claimer: this.toHash(results[i + 5]),\n          txHash: this.toHash(results[i + 6])\n        });\n      }\n\n      success(tickets);\n\n      // TODO\n      // for (var i = 0; i < results.length; i += 1) {\n      //   var ticketId = results[i][0];\n      //   if (!ticketId)\n      //     break;\n\n      //   var bnWei = results[i][2];\n      //   var bnWeiPerSatoshi = results[i][3];\n\n      //   tickets.push({\n      //     ticketId: ticketId.toNumber(),\n      //     btcAddr: this.toBtcAddr(results[i][1]),\n      //     numWei: bnWei.toString(),\n      //     btcTotal: this.toBtcTotal(bnWei, bnWeiPerSatoshi),\n      //     numClaimExpiry: results[i][4].toNumber()\n      //     // bnClaimer: ticketArr[i + 5].toString(10),\n      //     // bnClaimTxHash: ticketArr[i + 6].toString(10)\n      //   });\n      // }\n      // success(tickets);\n    }.bind(this));\n  };\n\n  this.lookupTicket = function(id, success, failure) {\n    this.contract.lookupTicket.call(id, function(error, result) {\n      if (error) {\n        failure(\"Error loading ticket \" + id + \": \" + String(error));\n        return;\n      }\n\n      if (this.debug)\n        console.log(\"LOOKUP\", result);\n\n      if (!result || !result[0] || !result[0].toNumber()) {\n        success(false);\n        return;\n      }\n\n      var bnWei = result[1];\n      var bnWeiPerSatoshi = result[2];\n\n      var ticket = {\n        id: id,\n        address: this.toBtcAddr(result[0]), // toBtcAddr(arr[0], this.versionAddr),\n        amount: bnWei.toString(), // toEther(bnWei),\n        price: this.toBtcPrice(bnWeiPerSatoshi),\n        total: this.toBtcTotal(bnWei, bnWeiPerSatoshi),\n        expiry: result[3].toNumber(),\n        claimer: this.toHash(result[4]),\n        txHash: this.toHash(result[5])\n      };\n\n      success(ticket);\n    }.bind(this));\n  };\n\n  this.verifyPoWClicked = function(ticketId, txHash, nonce, success, failure) {\n    var hexTicketId = new BigNumber(ticketId).toString(16);\n    var padLen = 16 - hexTicketId.length;\n    var leadZerosForTicketId = Array(padLen + 1).join('0');\n\n    var hexNonce = new BigNumber(nonce).toString(16);\n    padLen = 16 - hexNonce.length;\n    var leadZerosForNonce = Array(padLen + 1).join('0');\n\n    var bnSrc = new BigNumber('0x' + txHash + leadZerosForTicketId + hexTicketId + leadZerosForNonce + hexNonce);\n    var src;\n    var bnHash;\n    var strHash;\n\n    if (this.debug)\n      console.log('@@@ bnSrc: ', bnSrc.toString(16));\n\n    src = ku.hexStringToBytes(bnSrc.toString(16));\n    src = new Uint32Array(src.buffer);\n    var srcLen = src.length;\n    var dst = new Uint32Array(8);\n    kecc.digestWords(dst, 0, 8, src, 0, srcLen);\n\n    strHash = ku.wordsToHexString(dst);\n    bnHash = new BigNumber('0x' + strHash);\n\n    var isPowValid = bnHash.lt(bnTarget);\n    if (this.debug)\n      console.log('@@@ isPowValid: ', isPowValid, ' pow: ', bnHash.toString(16), ' target: ', bnTarget.toString(16));\n\n    if (isPowValid) {\n      success('Proof of Work valid');\n    }\n    else {\n      failure('Proof of Work invalid');\n    }\n  };\n\n  this.computePoW = function(ticketId, btcTxHash, success, failure) {\n    try {\n      // var powPromise = new Promise(function(resolve, reject) {\n        if (this.debug)\n          console.log('@@@ computePow txhash: ', btcTxHash);\n\n        var hexTicketId = new BigNumber(ticketId).toString(16);\n        var padLen = 8 - hexTicketId.length;\n        var leadZerosForTicketId = Array(padLen + 1).join('0');\n\n        var bnSrc = new BigNumber('0x' + btcTxHash + leadZerosForTicketId + hexTicketId + \"0000000000000000\");\n        var src;\n        var bnHash;\n        var strHash;\n\n        if (this.debug)\n          console.log('@@@ bnSrc: ', bnSrc.toString(16));\n\n        src = ku.hexStringToBytes(bnSrc.toString(16));\n        src = new Uint32Array(src.buffer);\n        var srcLen = src.length;\n        var dst = new Uint32Array(8);\n        kecc.digestWords(dst, 0, 8, src, 0, srcLen);\n\n        strHash = ku.wordsToHexString(dst);\n        bnHash = new BigNumber('0x' + strHash);\n\n\n        var startTime = new Date().getTime();\n        if (this.debug)\n          console.log(\"startTime: \", startTime);\n\n        var start = 0;\n        var tryPoW = function(i) {\n          bnSrc = bnSrc.add(1);\n\n          src = ku.hexStringToBytes(bnSrc.toString(16));\n          src = new Uint32Array(src.buffer);\n          kecc.digestWords(dst, 0, 8, src, 0, srcLen);\n\n          strHash = ku.wordsToHexString(dst);\n          bnHash = new BigNumber('0x' + strHash);\n          if (this.debug)\n            console.log(\"PASS\", i, strHash, \"DIFF\", bnTarget.minus(bnHash).toString());\n\n          if (i >= 1000)\n            failure(\"PoW failed.\");\n            // reject(\"PoW failed.\");\n\n          i += 1;\n          if (bnHash.gte(bnTarget) && i < 1000)\n            setTimeout(tryPoW, 10, i);\n          else {\n            success(i);\n\n            if (this.debug) {\n              console.log(\"endTime: \", new Date().getTime());\n              console.log(\"duration: \", (new Date().getTime() - startTime) / 1000.0);\n\n              console.log('@@@@ nonce: ', i);\n              console.log('@@@ strHash: ', strHash);\n            }\n          }\n            // resolve(i);\n        }.bind(this);\n\n        tryPoW(start);\n\n        // var i = 0;\n        // while (bnHash.gte(bnTarget) && i < 100000000) {\n        //   setTimeout(tryPoW(i), 1);\n        //   i += 1;\n        // }\n\n        // if (i === 100000000)\n        //   reject(\"PoW failed.\");\n\n        // resolve(i);\n      // }.bind(this));\n\n      // powPromise.then(function (nonce) {\n      //     success(nonce);\n      // }, function (e) {\n      //     failure(String(e));\n      // });\n    }\n    catch(e) {\n      failure(e);\n    }\n  };\n\n  this.merkleProof = function(tx, index) {\n    return btcproof.getProof(tx, index);\n  };\n\n  this.debugVerifyTx = function() {\n    // TODO don't forget to update the ABI\n    var dbgAddress = '0x90439a6495ee8e7d86a4acd2cbe649ed21e2ef6e';\n    var dbgContract = web3.eth.contract(debugAbi).at(dbgAddress);\n\n    var txHash = '0x558231b40b5fdddb132f9fcc8dd82c32f124b6139ecf839656f4575a29dca012';\n    var dbgEvent = dbgContract.dbgEvent({ txHash: txHash });\n\n    var txhEvent = dbgContract.txhEvent({ txHash: txHash });\n\n\n    dbgEvent.watch(function(err, res) {\n      if (err) {\n        console.log('@@@ dbgEvent err: ', err);\n        return;\n      }\n\n      console.log('@@@ dbgEvent res: ', res);\n    });\n\n\n    txhEvent.watch(function(err, res) {\n      if (err) {\n        console.log('@@@ txhEvent err: ', err);\n        return;\n      }\n\n      console.log('@@@ txhEvent res: ', res);\n    });\n  };\n\n  this.toBtcPrice = function(bnWeiPerSatoshi) {\n    return new BigNumber(1).div(bnWeiPerSatoshi.div(WEI_PER_ETHER).mul(SATOSHI_PER_BTC)).toString();\n  };\n\n  this.toBtcTotal = function(bnWei, bnWeiPerSatoshi) {\n    return bnWei.div(bnWeiPerSatoshi).div(SATOSHI_PER_BTC).round(8).toString(10);\n  };\n\n  this.toBtcAddr = function(bignum) {\n    var hexAddress = web3.fromDecimal(bignum).substr(2);\n    if (this.debug)\n      console.log('hexAddress:', hexAddress, 'versionByte: ', this.versionAddr);\n    return new bitcoin.Address(new Buffer(hexAddress, 'hex'), this.versionAddr).toString();\n  };\n\n  // needed for handling negative bignums\n  // http://stackoverflow.com/questions/3417183/modulo-of-negative-numbers/3417242#3417242\n  this.bignumToHex = function(bn) {\n    return bn.mod(TWO_POW_256).lt(0) ? bn.add(TWO_POW_256).toString(16) : bn.toString(16);\n\n    // return bn.mod(TWO_POW_256).add(TWO_POW_256).mod(TWO_POW_256).toString(16);\n  };\n\n  this.toHash = function(bignum) {\n    var hash = this.bignumToHex(bignum);\n    return hash === '0' ? '' : hash;\n  };\n\n  // var toEther = function(bnWei) {\n  //   return web3.fromWei(bnWei, 'ether').toString(10);\n  // };\n};\n\nmodule.exports = btcSwap;\n"]}